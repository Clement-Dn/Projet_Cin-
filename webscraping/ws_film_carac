import requests
from bs4 import BeautifulSoup
import re
import pandas as pd
import time

numero_films = pd.read_csv('numero_films.csv')
num_film = numero_films.sample(n=100)
liens = ["https://www.allocine.fr/film/fichefilm_gen_cfilm=" + str(num) + ".html" for num in num_film['num_film']]

i = 1
film_charac = []
for lien in liens:
    print(i)
    i = i + 1
    print(lien)
    code_page = requests.get(lien)
    soup = BeautifulSoup(code_page.text, 'html.parser')

    num = re.findall(r'\d+', lien)[0]

    titre_element = soup.find(class_='titlebar-title titlebar-title-xl')
    titre = titre_element.text.strip() if titre_element else ''

    date_element = soup.find(class_='date')
    date = date_element.text.strip() if date_element else ''

    release_element = soup.find('span', class_='meta-release-type')
    release = release_element.text.strip() if release_element else ''

    # Extrait la durée du film
    meta_body_info = soup.find('div', class_='meta-body-item meta-body-info')
    duree = ''
    if meta_body_info:
        duree_match = re.search(r'(\d+h\s*\d*min)', meta_body_info.text)
        if duree_match:
            duree = duree_match.group(1)

    # Extrait les données de la fiche technique
    fiche_tech = soup.find('section', class_='section ovw ovw-technical')
    if fiche_tech:
        nationalite_span = fiche_tech.find('span', string='Nationalité')
        nationalite = nationalite_span.find_next_sibling('span').text.strip() if nationalite_span else ''

        date_sortie_dvd_span = fiche_tech.find('span', string='Date de sortie DVD')
        date_sortie_dvd = date_sortie_dvd_span.find_next_sibling('span').text.strip() if date_sortie_dvd_span else ''

        date_sortie_bluray_span = fiche_tech.find('span', string='Date de sortie Blu-ray')
        date_sortie_bluray = date_sortie_bluray_span.find_next_sibling('span').text.strip() if date_sortie_bluray_span else ''

        date_sortie_vod_span = fiche_tech.find('span', string='Date de sortie VOD')
        date_sortie_vod = date_sortie_vod_span.find_next_sibling('span').text.strip() if date_sortie_vod_span else ''

        type_film_span = fiche_tech.find('span', string='Type de film')
        type_film = type_film_span.find_next_sibling('span').text.strip() if type_film_span else ''

        budget_span = fiche_tech.find('span', string='Budget')
        budget = budget_span.find_next_sibling('span').text.strip() if budget_span else ''

        langues_span = fiche_tech.find('span', string='Langues')
        langues = langues_span.find_next_sibling('span').text.strip() if langues_span else ''

        format_production_span = fiche_tech.find('span', string='Format production')
        format_production = format_production_span.find_next_sibling('span').text.strip() if format_production_span else ''

        couleur_span = fiche_tech.find('span', string='Couleur')
        couleur = couleur_span.find_next_sibling('span').text.strip() if couleur_span else ''

        format_audio_span = fiche_tech.find('span', string='Format audio')
        format_audio = format_audio_span.find_next_sibling('span').text.strip() if format_audio_span else ''

        format_projection_span = fiche_tech.find('span', string='Format de projection')
        format_projection = format_projection_span.find_next_sibling('span').text.strip() if format_projection_span else ''

        num_visa_span = fiche_tech.find('span', string='N° de Visa')
        num_visa = num_visa_span.find_next_sibling('span').text.strip() if num_visa_span else ''
    else:
        nationalite = date_sortie_dvd = date_sortie_bluray = date_sortie_vod = type_film = budget = langues = format_production = couleur = format_audio = format_projection = num_visa = ''

    film_charac.append([num, titre, date, duree, nationalite, date_sortie_dvd, date_sortie_bluray, date_sortie_vod, type_film, budget, langues, format_production, couleur, format_audio, format_projection, num_visa])

print(film_charac)

# Créer un DataFrame pandas avec les numéros de films
df = pd.DataFrame(film_charac, columns=['num_film', 'titre', 'date', 'duree', 'release', 'nationalite', 'date_sortie_dvd', 'date_sortie_bluray', 'date_sortie_vod', 'type_film', 'budget', 'langues', 'format_production', 'couleur', 'format_audio', 'format_projection', 'num_visa'])
# Enregistrer le DataFrame dans un fichier CSV
df.to_csv('charc_num_titre.csv', index=False)
